<html>
	<head>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<script src="http://wrt/js/highcharts.js" type="text/javascript"></script>
		<script src="http://wrt/js/modules/exporting.js" type="text/javascript"></script>
		<script>

$(function () {

Highcharts.setOptions({
    global: {
        useUTC: false
    }
});

var timestamp;
//var meters = [[], [], [], [], []];
//var meter_names = [ 'meter1', 'meter2', 'meter3', 'lost', 'total' ];

var meters = {
	meter1: {
		loaded: false,
		src: 'http://wrt/smartmeter_meter1_watt.rrd',
		data: []
	},
	meter2: {
		loaded: false,
		src: 'http://wrt/smartmeter_meter2_watt.rrd',
		data: []
	},
	meter3: {
		loaded: false,
		src: 'http://wrt/smartmeter_meter3_watt.rrd',
		data: []
	},
	lost: {
		loaded: false,
		src: 'http://wrt/smartmeter_lost_watt.rrd',
		data: []
	},
	total: {
		loaded: false,
		src: 'http://wrt/smartmeter_total_watt.rrd',
		data: []
	},
};

average = function(a){
    var r = {mean: 0, variance: 0, deviation: 0}, t = a.length;
    for(var m, s = 0, l = t; l--; s += a[l]);
    for(m = r.mean = s / t, l = t, s = 0; l--; s += Math.pow(a[l] - m, 2));
    return r.deviation = Math.sqrt(r.variance = s / t), r;
}


var numLoaded = 0;

    var chart;
    function draw_chart() {
	//var avg = average(meters.total.data);
        chart = new Highcharts.Chart({
            chart: {
                renderTo: 'container',
                type: 'column',
                zoomType: 'x'
            },
            title: {
                text: 'Power consumption'
            },
            subtitle: {
                text: '(We\'ve got to take the power back!)'
            },
            xAxis: {
                type: 'datetime',
                dateTimeLabelFormats: { // don't display the dummy year
                    month: '%e. %b',
                    year: '%b'
                }
            },
            yAxis: {
	plotBands: [{
		color: 'white',
		width: 20,
//		from: this.series.data.min,
//		to: this.series.data.max,
//		value: average(this.series[4].data).mean
//
	}],
				//type: 'logarithmic',
				//min: 100,
								//minorTickInterval: 1000,
                title: {
                    text: 'Power (W)'
                },
                min: 0
            },
            tooltip: {
                formatter: function() {
                        return '<b>'+ this.series.name +'</b><br/>'+
                        Highcharts.dateFormat('%e. %b %H:%M', this.x) +': '+ this.y +' W';
                }
            },
plotOptions: {
column: {
                    stacking: 'normal'},
                areaspline: {
                    pointStart: 1940,
                    marker: {
                        enabled: false,
                        symbol: 'circle',
                        radius: 2,
                        states: {
                            hover: {
                                enabled: true
                            }
                        }
                    }
                },
                spline: {
                    pointStart: 1940,
                    marker: {
                        enabled: false,
                        symbol: 'circle',
                        radius: 2,
                        states: {
                            hover: {
                                enabled: true
                            }
                        }
                    }
                }
            },
            
            series: [{
                name: 'Meter 1',
                zIndex: 2,
				color: "#55ff55",
                data: meters.meter1.data
            }, {
                name: 'Meter 2',
                zIndex: 2,
				color: "#eeee44",
                data: meters.meter2.data
            }, {
                name: 'Meter 3',
                zIndex: 2,
				color: "#5555ff",
                data: meters.meter3.data
            }, {
                name: 'Lost',
                zIndex: 5,
				color: "#FF5555",
                data: meters.lost.data
            }, {
                name: 'Total',
				type: 'areaspline',
                zIndex: 1,
				color: "#dddddd",
                data: meters.total.data
            }]
        });
    };


$.each(meters, function(meter_no, meter_name) {
 $.get(meter_name.src, function(data) {
	 // Split the lines
	 var lines = data.split('\n');

	 $.each(lines, function(lineNo, line) {
		 var items = line.split(',');

		 // header line contains no data
		 if (lineNo > 0) {
			 $.each(items, function(itemNo, item) {
				 if (itemNo == 0) {
					 timestamp = item.replace(":","") * 1000;
				 } else {
						//if (item <= 0) { item = 1}
					 //alert("Name: " + names[(itemNo)]);
					 meter_name.data.push( [ timestamp, parseFloat(item) ] );
				 }
			 });


		 }

	 });
	meter_name.loaded = true;
	numLoaded++;
	console.log("numLoaded: " + numLoaded);
	if (numLoaded == 5) {
		draw_chart();
	}
 });
});

//document.write("<h1>" + chart.series[4] + "</h1>");
});


/**
 * Gray theme for Highcharts JS
 * @author Torstein HÃ¸nsi
 */


Highcharts.theme = {
   colors: ["#DDDF0D", "#7798BF", "#55BF3B", "#DF5353", "#aaeeee", "#ff0066", "#eeaaee",
      "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"],
   chart: {
      backgroundColor: {
         linearGradient: [0, 0, 0, 400],
         stops: [
            [0, 'rgb(96, 96, 96)'],
            [1, 'rgb(16, 16, 16)']
         ]
      },
      borderWidth: 0,
      borderRadius: 15,
      plotBackgroundColor: null,
      plotShadow: false,
      plotBorderWidth: 0
   },
   title: {
      style: {
         color: '#FFF',
         font: '16px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
      }
   },
   subtitle: {
      style: {
         color: '#DDD',
         font: '12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
      }
   },
   xAxis: {
      gridLineWidth: 0,
      lineColor: '#999',
      tickColor: '#999',
      labels: {
         style: {
            color: '#999',
            fontWeight: 'bold'
         }
      },
      title: {
         style: {
            color: '#AAA',
            font: 'bold 12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
         }
      }
   },
   yAxis: {
      alternateGridColor: null,
      minorTickInterval: null,
      gridLineColor: 'rgba(255, 255, 255, .1)',
      lineWidth: 0,
      tickWidth: 0,
      labels: {
         style: {
            color: '#999',
            fontWeight: 'bold'
         }
      },
      title: {
         style: {
            color: '#AAA',
            font: 'bold 12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
         }
      }
   },
   legend: {
      itemStyle: {
         color: '#CCC'
      },
      itemHoverStyle: {
         color: '#FFF'
      },
      itemHiddenStyle: {
         color: '#333'
      }
   },
   labels: {
      style: {
         color: '#CCC'
      }
   },
   tooltip: {
      backgroundColor: {
         linearGradient: [0, 0, 0, 50],
         stops: [
            [0, 'rgba(96, 96, 96, .8)'],
            [1, 'rgba(16, 16, 16, .8)']
         ]
      },
      borderWidth: 0,
      style: {
         color: '#FFF'
      }
   },


   plotOptions: {
      line: {
         dataLabels: {
            color: '#CCC'
         },
         marker: {
            lineColor: '#333'
         }
      },
      spline: {
         marker: {
            lineColor: '#333'
         }
      },
      scatter: {
         marker: {
            lineColor: '#333'
         }
      },
      candlestick: {
         lineColor: 'white'
      }
   },

   toolbar: {
      itemStyle: {
         color: '#CCC'
      }
   },

   navigation: {
      buttonOptions: {
         backgroundColor: {
            linearGradient: [0, 0, 0, 20],
            stops: [
               [0.4, '#606060'],
               [0.6, '#333333']
            ]
         },
         borderColor: '#000000',
         symbolStroke: '#C0C0C0',
         hoverSymbolStroke: '#FFFFFF'
      }
   },

   exporting: {
      buttons: {
         exportButton: {
            symbolFill: '#55BE3B'
         },
         printButton: {
            symbolFill: '#7797BE'
         }
      }
   },

   // scroll charts
   rangeSelector: {
      buttonTheme: {
         fill: {
            linearGradient: [0, 0, 0, 20],
            stops: [
               [0.4, '#888'],
               [0.6, '#555']
            ]
         },
         stroke: '#000000',
         style: {
            color: '#CCC',
            fontWeight: 'bold'
         },
         states: {
            hover: {
               fill: {
                  linearGradient: [0, 0, 0, 20],
                  stops: [
                     [0.4, '#BBB'],
                     [0.6, '#888']
                  ]
               },
               stroke: '#000000',
               style: {
                  color: 'white'
               }
            },
            select: {
               fill: {
                  linearGradient: [0, 0, 0, 20],
                  stops: [
                     [0.1, '#000'],
                     [0.3, '#333']
                  ]
               },
               stroke: '#000000',
               style: {
                  color: 'yellow'
               }
            }
         }
      },
      inputStyle: {
         backgroundColor: '#333',
         color: 'silver'
      },
      labelStyle: {
         color: 'silver'
      }
   },

   navigator: {
      handles: {
         backgroundColor: '#666',
         borderColor: '#AAA'
      },
      outlineColor: '#CCC',
      maskFill: 'rgba(16, 16, 16, 0.5)',
      series: {
         color: '#7798BF',
         lineColor: '#A6C7ED'
      }
   },

   scrollbar: {
      barBackgroundColor: {
            linearGradient: [0, 0, 0, 20],
            stops: [
               [0.4, '#888'],
               [0.6, '#555']
            ]
         },
      barBorderColor: '#CCC',
      buttonArrowColor: '#CCC',
      buttonBackgroundColor: {
            linearGradient: [0, 0, 0, 20],
            stops: [
               [0.4, '#888'],
               [0.6, '#555']
            ]
         },
      buttonBorderColor: '#CCC',
      rifleColor: '#FFF',
      trackBackgroundColor: {
         linearGradient: [0, 0, 0, 10],
         stops: [
            [0, '#000'],
            [1, '#333']
         ]
      },
      trackBorderColor: '#666'
   },

   // special colors for some of the demo examples
   legendBackgroundColor: 'rgba(48, 48, 48, 0.8)',
   legendBackgroundColorSolid: 'rgb(70, 70, 70)',
   dataLabelsColor: '#444',
   textColor: '#E0E0E0',
   maskColor: 'rgba(255,255,255,0.3)'
};

// Apply the theme
var highchartsOptions = Highcharts.setOptions(Highcharts.theme);

		</script>
	</head>
	<body>
		<div id="container" style="width: 100%; height: 400px"></div>

	</body>
</html>

