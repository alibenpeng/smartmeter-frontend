<html>
	<head>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<script src="/js/highcharts.js" type="text/javascript"></script>
		<script src="/js/modules/exporting.js" type="text/javascript"></script>
		<script>

$(function () {

Highcharts.setOptions({
    global: {
        useUTC: false
    }
});

var timestamp;
//var meters = [[], [], [], [], []];
//var meter_names = [ 'meter1', 'meter2', 'meter3', 'lost', 'total' ];

var meters = {
	meter1: {
		loaded: false,
		src: 'http://wrt/data_meter1_24h.csv',
		data: []
	},
	meter2: {
		loaded: false,
		src: 'http://wrt/data_meter2_24h.csv',
		data: []
	},
	meter3: {
		loaded: false,
		src: 'http://wrt/data_meter3_24h.csv',
		data: []
	},
	lost: {
		loaded: false,
		src: 'http://wrt/data_lost_24h.csv',
		data: []
	},
	total: {
		loaded: false,
		src: 'http://wrt/data_total_24h.csv',
		data: []
	},
};

var numLoaded = 0;

// master detail chart


    var masterChart,
        detailChart;
    
    //$(document).ready(function() {
    function draw_chart() {
    
    
        // create the master chart
        function createMaster() {
            masterChart = new Highcharts.Chart({
                chart: {
                    renderTo: 'master-container',
                    reflow: false,
                    borderWidth: 0,
                    backgroundColor: null,
                    marginLeft: 50,
                    marginRight: 20,
                    zoomType: 'x',
                    events: {
    
                        // listen to the selection event on the master chart to update the
                        // extremes of the detail chart
                        selection: function(event) {
                            var extremesObject = event.xAxis[0],
                                min = extremesObject.min,
                                max = extremesObject.max,
                                detailData = [[], [], [], [], []],
                                xAxis = this.xAxis[0];
    
                            // reverse engineer the last part of the data
																											for (counterNo = 0; counterNo < 5; counterNo++) {
                            jQuery.each(this.series[(counterNo)].data, function(i, point) {
                                if (point.x > min && point.x < max) {
                                    detailData[(counterNo)].push({
                                        x: point.x,
                                        y: point.y
                                    });
                                }
                            });
																											};
    
                            // move the plot bands to reflect the new detail span
                            xAxis.removePlotBand('mask-before');
                            xAxis.addPlotBand({
                                id: 'mask-before',
                                from: Date.UTC(2012, 4, 1),
                                to: min,
                                color: 'rgba(0, 0, 0, 0.2)'
                            });
    
                            xAxis.removePlotBand('mask-after');
                            xAxis.addPlotBand({
                                id: 'mask-after',
                                from: max,
                                to: Date.UTC(),
                                color: 'rgba(0, 0, 0, 0.2)'
                            });
    
    
	for (detailDataSet = 0; detailDataSet < 5; detailDataSet++) {
                            //detailChart.series[0].setData(detailData[4]);
                            detailChart.series[(detailDataSet)].setData(detailData[(detailDataSet)]);
	}
    
                            return false;
                        }
                    }
                },
                title: {
                    text: null
                },
                xAxis: {
                    type: 'datetime',
                    showLastTickLabel: true,
                    maxZoom: 14 * 24 * 3600000, // fourteen days
                    plotBands: [{
                        id: 'mask-before',
                        from: Date.UTC(2012, 4, 1),
                        to: Date.UTC(),
                        color: 'rgba(0, 0, 0, 0.2)'
                    }],
                    title: {
                        text: null
                    }
                },
                yAxis: {
                    gridLineWidth: 0,
                    labels: {
                        enabled: false
                    },
                    title: {
                        text: null
                    },
                    min: 0.6,
                    showFirstLabel: false
                },
                tooltip: {
                    formatter: function() {
                        return false;
                    }
                },
                legend: {
                    enabled: false
                },
                credits: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        fillColor: {
                            linearGradient: [0, 0, 0, 70],
                            stops: [
                                [0, '#4572A7'],
                                [1, 'rgba(0,0,0,0)']
                            ]
                        },
                        lineWidth: 1,
                        marker: {
                            enabled: false
                        },
                        shadow: false,
                        states: {
                            hover: {
                                lineWidth: 1
                            }
                        },
                        enableMouseTracking: false
                    }
                },
    
            series: [{
                name: 'meter 1',
                zindex: 2,
				color: "#55ff55",
                data: meters.meter1.data
            }, {
                name: 'meter 2',
                zindex: 2,
				color: "#eeee44",
                data: meters.meter2.data
            }, {
                name: 'meter 3',
                zindex: 2,
				color: "#5555ff",
                data: meters.meter3.data
            }, {
                name: 'lost',
                zindex: 5,
				color: "#ff5555",
                data: meters.lost.data
            }, {
                name: 'total',
				type: 'area',
                zindex: 1,
				color: "#dddddd",
                data: meters.total.data
            }],
/*
                series: [{
                    type: 'area',
                    name: 'USD to EUR',
                    pointInterval: 24 * 3600 * 1000,
                    pointStart: Date.UTC(2006, 0, 01),
                    data: data
                }],
*/
    
                exporting: {
                    enabled: false
                }
    
            }, function(masterChart) {
                createDetail(masterChart)
            });
        }
    
        // create the detail chart
        function createDetail(masterChart) {
    
            // prepare the detail chart
            var detailData = [[], [], [], [], []],
                detailStart = Date.UTC(2012, 4, 1);
    
for (j = 0; j < 5; j++) {
            jQuery.each(masterChart.series[(j)].data, function(i, point) {
                if (point.x >= detailStart) {
                    detailData[(j)].push(point.y);
                }
            });
	}
    
            // create a detail chart referenced by a global variable
            detailChart = new Highcharts.Chart({
                chart: {
                    marginBottom: 120,
                    renderTo: 'detail-container',
                    reflow: false,
                    marginLeft: 50,
                    marginRight: 20,
                    style: {
                        position: 'absolute'
                    }
                },
                credits: {
                    enabled: false
                },
                title: {
                    text: 'Power consumption'
                },
                subtitle: {
                    text: 'Select an area by dragging across the lower chart'
                },
                xAxis: {
                    type: 'datetime'
                },
                yAxis: {
                    title: {
                        text: null
                    },
                    maxZoom: 0.1
                },
            tooltip: {
                formatter: function() {
                        return '<b>'+ this.series.name +'</b><br/>'+
                        Highcharts.dateFormat('%e. %b', this.x) +': '+ this.y +' W';
                }
            },
/*
                tooltip: {
                    formatter: function() {
                        var point = this.points[0];
                        return '<b>'+ point.series.name +'</b><br/>'+
                            Highcharts.dateFormat('%A %B %e %Y', this.x) + ':<br/>'+
                            '1 USD = '+ Highcharts.numberFormat(point.y, 2) +' EUR';
                    },
                    shared: true
                },
                legend: {
                    enabled: false
                },
*/
                plotOptions: {
                    series: {
                        marker: {
                            enabled: false,
                            states: {
                                hover: {
                                    enabled: true,
                                    radius: 3
                                }
                            }
                        }
                    }
                },
            series: [{
                name: 'meter 1',
                zindex: 2,
				color: "#55ff55",
                    data: detailData[0]
                //data: meters.meter1.data
            }, {
                name: 'meter 2',
                zindex: 2,
				color: "#eeee44",
                    data: detailData[1]
                //data: meters.meter2.data
            }, {
                name: 'meter 3',
                zindex: 2,
				color: "#5555ff",
                    data: detailData[2]
                //data: meters.meter3.data
            }, {
                name: 'lost',
                zindex: 5,
				color: "#ff5555",
                    data: detailData[3]
                //data: meters.lost.data
            }, {
                name: 'total',
				type: 'area',
                zindex: 1,
				color: "#dddddd",
                    data: detailData[4]
                //data: meters.total.data
            }],
/*
                series: [{
                    name: 'USD to EUR',
                    pointStart: detailStart,
                    pointInterval: 24 * 3600 * 1000,
                    data: detailData
                }],
    
                exporting: {
                    enabled: false
                }
*/
    
            });
        }
    
        // make the container smaller and add a second container for the master chart
        var $container = $('#container')
            .css('position', 'relative');
    
        var $detailContainer = $('<div id="detail-container">')
            .appendTo($container);
    
        var $masterContainer = $('<div id="master-container">')
            .css({ position: 'absolute', top: 285, height: 80, width: '100%' })
            .appendTo($container);
    
        // create master and in its callback, create the detail chart
        createMaster();
    };
    

// get and parse cvs data
$.each(meters, function(meter_no, meter_name) {
 $.get(meter_name.src, function(data) {
	 // Split the lines
	 var lines = data.split('\n');

	 $.each(lines, function(lineNo, line) {
		 var items = line.split(',');

		 // header line contains no data
		 if (lineNo > 0) {
			 $.each(items, function(itemNo, item) {
				 if (itemNo == 0) {
					 timestamp = item.replace(":","") * 1000;
				 } else {
						//if (item <= 0) { item = 1}
					 //alert("Name: " + names[(itemNo)]);
					 meter_name.data.push( [ timestamp, parseFloat(item) ] );
				 }
			 });


		 }

	 });
	meter_name.loaded = true;
	numLoaded++;
	console.log("numLoaded: " + numLoaded);
	if (numLoaded == 5) {
		draw_chart();
	}
 });
});

});


/**
 * Gray theme for Highcharts JS
 * @author Torstein HÃ¸nsi
 */


Highcharts.theme = {
   colors: ["#DDDF0D", "#7798BF", "#55BF3B", "#DF5353", "#aaeeee", "#ff0066", "#eeaaee",
      "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"],
   chart: {
      backgroundColor: {
         linearGradient: [0, 0, 0, 400],
         stops: [
            [0, 'rgb(96, 96, 96)'],
            [1, 'rgb(16, 16, 16)']
         ]
      },
      borderWidth: 0,
      borderRadius: 15,
      plotBackgroundColor: null,
      plotShadow: false,
      plotBorderWidth: 0
   },
   title: {
      style: {
         color: '#FFF',
         font: '16px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
      }
   },
   subtitle: {
      style: {
         color: '#DDD',
         font: '12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
      }
   },
   xAxis: {
      gridLineWidth: 0,
      lineColor: '#999',
      tickColor: '#999',
      labels: {
         style: {
            color: '#999',
            fontWeight: 'bold'
         }
      },
      title: {
         style: {
            color: '#AAA',
            font: 'bold 12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
         }
      }
   },
   yAxis: {
      alternateGridColor: null,
      minorTickInterval: null,
      gridLineColor: 'rgba(255, 255, 255, .1)',
      lineWidth: 0,
      tickWidth: 0,
      labels: {
         style: {
            color: '#999',
            fontWeight: 'bold'
         }
      },
      title: {
         style: {
            color: '#AAA',
            font: 'bold 12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
         }
      }
   },
   legend: {
      itemStyle: {
         color: '#CCC'
      },
      itemHoverStyle: {
         color: '#FFF'
      },
      itemHiddenStyle: {
         color: '#333'
      }
   },
   labels: {
      style: {
         color: '#CCC'
      }
   },
   tooltip: {
      backgroundColor: {
         linearGradient: [0, 0, 0, 50],
         stops: [
            [0, 'rgba(96, 96, 96, .8)'],
            [1, 'rgba(16, 16, 16, .8)']
         ]
      },
      borderWidth: 0,
      style: {
         color: '#FFF'
      }
   },


   plotOptions: {
      line: {
         dataLabels: {
            color: '#CCC'
         },
         marker: {
            lineColor: '#333'
         }
      },
      spline: {
         marker: {
            lineColor: '#333'
         }
      },
      scatter: {
         marker: {
            lineColor: '#333'
         }
      },
      candlestick: {
         lineColor: 'white'
      }
   },

   toolbar: {
      itemStyle: {
         color: '#CCC'
      }
   },

   navigation: {
      buttonOptions: {
         backgroundColor: {
            linearGradient: [0, 0, 0, 20],
            stops: [
               [0.4, '#606060'],
               [0.6, '#333333']
            ]
         },
         borderColor: '#000000',
         symbolStroke: '#C0C0C0',
         hoverSymbolStroke: '#FFFFFF'
      }
   },

   exporting: {
      buttons: {
         exportButton: {
            symbolFill: '#55BE3B'
         },
         printButton: {
            symbolFill: '#7797BE'
         }
      }
   },

   // scroll charts
   rangeSelector: {
      buttonTheme: {
         fill: {
            linearGradient: [0, 0, 0, 20],
            stops: [
               [0.4, '#888'],
               [0.6, '#555']
            ]
         },
         stroke: '#000000',
         style: {
            color: '#CCC',
            fontWeight: 'bold'
         },
         states: {
            hover: {
               fill: {
                  linearGradient: [0, 0, 0, 20],
                  stops: [
                     [0.4, '#BBB'],
                     [0.6, '#888']
                  ]
               },
               stroke: '#000000',
               style: {
                  color: 'white'
               }
            },
            select: {
               fill: {
                  linearGradient: [0, 0, 0, 20],
                  stops: [
                     [0.1, '#000'],
                     [0.3, '#333']
                  ]
               },
               stroke: '#000000',
               style: {
                  color: 'yellow'
               }
            }
         }
      },
      inputStyle: {
         backgroundColor: '#333',
         color: 'silver'
      },
      labelStyle: {
         color: 'silver'
      }
   },

   navigator: {
      handles: {
         backgroundColor: '#666',
         borderColor: '#AAA'
      },
      outlineColor: '#CCC',
      maskFill: 'rgba(16, 16, 16, 0.5)',
      series: {
         color: '#7798BF',
         lineColor: '#A6C7ED'
      }
   },

   scrollbar: {
      barBackgroundColor: {
            linearGradient: [0, 0, 0, 20],
            stops: [
               [0.4, '#888'],
               [0.6, '#555']
            ]
         },
      barBorderColor: '#CCC',
      buttonArrowColor: '#CCC',
      buttonBackgroundColor: {
            linearGradient: [0, 0, 0, 20],
            stops: [
               [0.4, '#888'],
               [0.6, '#555']
            ]
         },
      buttonBorderColor: '#CCC',
      rifleColor: '#FFF',
      trackBackgroundColor: {
         linearGradient: [0, 0, 0, 10],
         stops: [
            [0, '#000'],
            [1, '#333']
         ]
      },
      trackBorderColor: '#666'
   },

   // special colors for some of the demo examples
   legendBackgroundColor: 'rgba(48, 48, 48, 0.8)',
   legendBackgroundColorSolid: 'rgb(70, 70, 70)',
   dataLabelsColor: '#444',
   textColor: '#E0E0E0',
   maskColor: 'rgba(255,255,255,0.3)'
};

// Apply the theme
var highchartsOptions = Highcharts.setOptions(Highcharts.theme);

		</script>
	</head>
	<body>
		<div id="container" style="width: 100%; height: 400px"></div>

	</body>
</html>

